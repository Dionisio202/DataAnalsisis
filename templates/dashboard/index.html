{% extends "admin/base_site.html" %}
{% load static %}

{% block title %}Dashboard Ambiental{% endblock %}

{% block extrastyle %}
<style>
  * { box-sizing: border-box; }
  
  .wrap { 
    max-width: 1400px;
    margin: 0 auto;
    padding: 2rem 1.5rem;
    display: grid; 
    grid-template-columns: 1fr; 
    gap: 2rem;
    /* FIX: fuerza controles en claro en fondos oscuros */
    color-scheme: light;
  }

  /* Header */
  .dashboard-header { 
    display: flex; 
    justify-content: space-between;
    align-items: flex-start;
    gap: 1.5rem;
    flex-wrap: wrap;
    margin-bottom: 1rem;
    /* FIX: hereda modo claro */
    color-scheme: light;
  }
  
  .dashboard-header h1 { 
    margin: 0;
    font-size: 1.875rem;
    font-weight: 700;
    color: #111827;
  }

  .filters-container {
    display: grid; 
    grid-auto-flow: column; 
    gap: 1rem;
    align-items: end;
    /* FIX: hereda modo claro */
    color-scheme: light;
  }

  .filter-group { 
    min-width: 220px; 
  }

  .filter-group {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    min-width: 200px;
  }

  .filter-group label {
    margin: 0;
    line-height: 1.1;
  }

  .filter-group select,
  .filter-group input[type="date"] {
    margin-top: 6px;
    padding: 0.625rem 0.875rem;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    background: white;
    font-size: 0.875rem;
    color: #374151;
    cursor: pointer;
    transition: border-color 0.2s;
    /* FIX: normaliza render en dark bg */
    font-family: inherit;
    line-height: 1.2;
    height: 42px;
    padding: 0 0.875rem;      /* solo horizontal para evitar clipping */
    background-color: #fff;
    color: #111827;
    appearance: none;
    -webkit-appearance: none;
    background-clip: padding-box;
    color-scheme: light;      /* fuerza claro en el control */
  }

  .filter-group input[type="date"] {
    min-width: 160px;
  }

  .filter-group select:hover,
  .filter-group input[type="date"]:hover {
    border-color: #9ca3af;
  }

  .filter-group select:focus,
  .filter-group input[type="date"]:focus {
    outline: none;
    border-color: #3b82f6;
    box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
  }

  .btn-apply {
    padding: 0.625rem 1.5rem;
    background: #3b82f6;
    color: white;
    border: none;
    border-radius: 8px;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: background 0.2s;
    width: 100%;
    margin-top: 0.25rem;
  }

  .btn-apply:hover {
    background: #2563eb;
  }

  .btn-apply:active {
    background: #1d4ed8;
  }

  .date-range-group {
    display: flex;
    flex-direction: column;
    gap: 0.75rem;
    padding: 1rem;
    background: #f9fafb;
    border-radius: 8px;
    border: 1px solid #e5e7eb;
    min-width: 400px;
  }

  .date-range-group.hidden {
    display: none;
  }

  .date-inputs {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 1rem;
  }

  .date-field {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
  }

  .date-field label {
    color: #6b7280;
    font-size: 0.875rem;
    font-weight: 600;
  }

  .date-field input[type="date"] {
    padding: 0.625rem 0.875rem;
    border: 1px solid #d1d5db;
    border-radius: 8px;
    background: white;
    font-size: 0.875rem;
    color: #374151;
    cursor: pointer;
    transition: border-color 0.2s;
    /* FIX: iguales mejoras que a los de arriba */
    font-family: inherit;
    line-height: 1.2;
    height: 42px;
    padding: 0 0.875rem;
    background-color: #fff;
    color: #111827;
    appearance: none;
    -webkit-appearance: none;
    background-clip: padding-box;
    color-scheme: light;
  }

  /* Cards Grid */
  .cards { 
    display: grid; 
    grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); 
    gap: 1.25rem;
  }
  
  .card { 
    border: 1px solid #e5e7eb; 
    border-radius: 12px; 
    padding: 1.5rem; 
    background: #fff;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
    transition: box-shadow 0.2s, transform 0.2s;
  }

  .card:hover {
    box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
    transform: translateY(-2px);
  }
  
  .card h3 { 
    margin: 0 0 0.75rem 0; 
    font-size: 0.875rem;
    font-weight: 600;
    color: #6b7280;
    text-transform: uppercase;
    letter-spacing: 0.5px;
  }
  
  .card .value { 
    font-size: 2rem; 
    font-weight: 700; 
    color: #111827;
    line-height: 1.2;
    margin-bottom: 1rem;
  } 
  
  .badge-row {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    margin-bottom: 1rem;
    flex-wrap: wrap;
  }

  .badge { 
    display: inline-block; 
    padding: 0.25rem 0.75rem; 
    border-radius: 6px; 
    font-size: 0.75rem;
    font-weight: 600;
    color: #fff;
  }

  .timestamp {
    color: #9ca3af;
    font-size: 0.75rem;
  }

  .card-stats {
    display: flex;
    flex-direction: column;
    gap: 0.5rem;
    padding-top: 1rem;
    border-top: 1px solid #f3f4f6;
  }

  .stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    font-size: 0.875rem;
  }

  .stat-label {
    color: #6b7280;
    font-weight: 500;
  }

  .stat-value {
    color: #374151;
    font-weight: 600;
  }

  .card-reference {
    margin-top: 0.75rem;
    padding-top: 0.75rem;
    border-top: 1px solid #f3f4f6;
    font-size: 0.8rem;
    color: #6b7280;
  }

  /* Main Content Grid */
  .content-grid { 
    display: grid; 
    grid-template-columns: 2fr 1fr; 
    gap: 1.5rem;
  }

  .panel { 
    border: 1px solid #e5e7eb; 
    border-radius: 12px; 
    padding: 1.5rem; 
    background: #fff;
    box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
  }

  .panel h3 { 
    margin: 0 0 1.25rem 0; 
    font-size: 1.125rem;
    font-weight: 700;
    color: #111827;
  }

  /* Charts */
  .charts-grid { 
    display: grid; 
    grid-template-columns: 1fr; 
    gap: 1.25rem;
  }
  
  .chart-card { 
    border: 1px solid #f3f4f6; 
    border-radius: 10px; 
    padding: 1rem; 
    background: #fafafa;
  }
  
  .chart-card h4 { 
    margin: 0 0 0.75rem 0; 
    font-size: 0.875rem;
    font-weight: 600;
    color: #374151;
  }
  
  canvas.small { 
    height: 200px !important;
  }

  /* Pie Chart */
  .pie-container {
    max-width: 400px;
    margin: 0 auto 1.5rem;
  }

  #pie_ambiente { 
    height: 280px !important;
  }

  .pie-note {
    text-align: center;
    color: #6b7280;
    font-size: 0.875rem;
    font-style: italic;
  }

  /* Table */
  .table-container {
    overflow-x: auto;
    margin-top: 1.5rem;
  }

  table { 
    width: 100%; 
    border-collapse: collapse;
    font-size: 0.875rem;
  }
  
  thead {
    background: #f9fafb;
  }

  th { 
    padding: 0.75rem 0.5rem;
    text-align: left;
    font-weight: 600;
    color: #374151;
    border-bottom: 2px solid #e5e7eb;
  }

  td { 
    padding: 0.75rem 0.5rem;
    border-bottom: 1px solid #f3f4f6;
    color: #6b7280;
  }

  tbody tr:hover {
    background: #f9fafb;
  }

  tbody tr:last-child td {
    border-bottom: none;
  }

  /* Responsive */
  @media (max-width: 1200px) { 
    .content-grid { grid-template-columns: 1fr; }
  }

  @media (max-width: 768px) {
    .wrap { padding: 1rem; }

    .dashboard-header {
      flex-direction: column;
      align-items: flex-start;
    }

    .dashboard-header h1 { font-size: 1.5rem; }

    .filters-container {
      display: grid; 
      grid-auto-flow: row; 
      gap: 1rem;
      width: 100%;
    }

    .filter-group {
      width: 100%;
      min-width: unset;
    }

    .filter-group select,
    .filter-group input[type="date"] {
      width: 100%;
    }

    .date-range-group { min-width: unset; width: 100%; }

    .date-inputs { grid-template-columns: 1fr; }

    .cards { grid-template-columns: 1fr; }

    .charts-grid { grid-template-columns: 1fr; }
  }
</style>

{% endblock %}

{% block content %}

<div class="wrap">

  <!-- Header -->
  <div class="dashboard-header">
    
    <div class="filters-container">
      <div class="filter-group">
        <label for="filterType">Filtrar por:</label>
        <select id="filterType">
          <option value="preset">Per√≠odo predefinido</option>
          <option value="custom">Rango personalizado</option>
        </select>
      </div>

      <div class="filter-group" id="presetFilter">
        <label for="rangeSelect">Per√≠odo:</label>
        <select id="rangeSelect">
          <option value="7">√öltimos 7 d√≠as</option>
          <option value="30" selected>√öltimos 30 d√≠as</option>
          <option value="90">√öltimos 90 d√≠as</option>
          <option value="180">√öltimos 180 d√≠as</option>
          <option value="365">√öltimo a√±o</option>
          <option value="all">Todo el per√≠odo</option>
        </select>
      </div>

      <div class="filter-group">
        <label for="ambienteSelect">Ambiente:</label>
        <select id="ambienteSelect">
          {% for amb in ambientes %}
            <option value="{{ amb.value }}">{{ amb.label }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="date-range-group hidden" id="customFilter">
        <div class="date-inputs">
          <div class="date-field">
            <label for="startDate">Fecha inicio:</label>
            <input type="date" id="startDate">
          </div>
          <div class="date-field">
            <label for="endDate">Fecha fin:</label>
            <input type="date" id="endDate">
          </div>
        </div>
        <button class="btn-apply" id="applyCustomRange">Aplicar Filtro</button>
      </div>
    </div>
  </div>

  <!-- KPI Cards -->
  <div class="cards" id="cards">
    {% for c in cards %}
      <div class="card" data-code="{{ c.code }}">
        <h3>{{ c.label }}</h3>
        <div class="value">
          {% if c.last_value is not None %}{{ c.last_value|floatformat:1 }} {{ c.unit }}{% else %}‚Äî{% endif %}
        </div>
        <div class="badge-row">
          <span class="badge" style="background-color: {{ c.category.color|default:'#6b7280' }};">
            {{ c.category.label }}
          </span>
          {% if c.last_at %}
            <span class="timestamp">{{ c.last_at|date:"d/m/y H:i" }}</span>
          {% endif %}
        </div>
        <div class="card-stats">
          <div class="stat-row">
            <span class="stat-label">Promedio</span>
            <span class="stat-value">
              {% if c.avg is not None %}{{ c.avg|floatformat:1 }} {{ c.unit }}{% else %}‚Äî{% endif %}
            </span>
          </div>
          <div class="stat-row">
            <span class="stat-label">M√≠nimo</span>
            <span class="stat-value">
              {% if c.min is not None %}{{ c.min|floatformat:1 }} {{ c.unit }}{% else %}‚Äî{% endif %}
            </span>
          </div>
          <div class="stat-row">
            <span class="stat-label">M√°ximo</span>
            <span class="stat-value">
              {% if c.max is not None %}{{ c.max|floatformat:1 }} {{ c.unit }}{% else %}‚Äî{% endif %}
            </span>
          </div>
        </div>
        {% if c.range_text %}
          <div class="card-reference">
            üìã Referencia: {{ c.range_text }}
          </div>
        {% endif %}
      </div>
    {% endfor %}
  </div>

  <!-- Main Content -->
  <div class="content-grid">
    
    <!-- Time Series Charts -->
    <div class="panel">
      <h3>Series Temporales</h3>
      <div class="charts-grid" id="chartsContainer">
        {% for code in metrics %}
          <div class="chart-card">
            <h4>{{ code }}</h4>
            <canvas id="line_{{ code }}" class="small"></canvas>
          </div>
        {% endfor %}
      </div>
    </div>

    <!-- Sidebar: Pie Chart + Reference Table -->
    <div class="panel">
      <h3>Distribuci√≥n por Ambiente</h3>
      <div class="pie-container">
        <canvas id="pie_ambiente"></canvas>
      </div>
      <p class="pie-note">
        Datos calculados para el per√≠odo seleccionado
      </p>

      <h3 style="margin-top: 2rem;">Valores de Referencia</h3>
      <div class="table-container">
        <table>
          <thead>
            <tr>
              <th>C√≥digo</th>
              <th>Par√°metro</th>
              <th>Unidad</th>
              <th>Rangos</th>
              <th>Uso</th>
            </tr>
          </thead>
          <tbody>
            {% for s in specs %}
              <tr>
                <td><strong>{{ s.code }}</strong></td>
                <td>{{ s.measured_param }}</td>
                <td>{{ s.unit }}</td>
                <td>{{ s.range_text }}</td>
                <td>{{ s.use_in_reports }}</td>
              </tr>
            {% empty %}
              <tr>
                <td colspan="5" style="text-align: center; padding: 2rem; color: #9ca3af;">
                  Sin especificaciones. Ejecuta el comando de seed.
                </td>
              </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>

  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js@4"></script>

<script>
  const initialDays = {{ initial_days|default:30 }};
  const metrics = {{ metrics|safe|default:"[]" }};

  let pieChart;
  const lineCharts = {};
  let currentFilterType = 'preset';
  let currentAmbiente = 'all';

  async function fetchJSON(url){ 
    const r = await fetch(url); 
    return r.json(); 
  }

async function loadCards(params){
  const queryString = new URLSearchParams(params).toString();
  const json = await fetchJSON(`/dashboard/api/summary/?${queryString}`);
  for (const c of json.cards){
    const el = document.querySelector(`.card[data-code="${c.code}"]`);
    if (!el) continue;

    // valor
    el.querySelector('.value').innerHTML =
      (c.last_value != null ? (c.last_value.toFixed(1) + ' ' + c.unit) : '‚Äî');

    // badge
    const badge = el.querySelector('.badge');
    badge.textContent = c.category.label || 'Sin categor√≠a';
    badge.style.backgroundColor = c.category.color || '#6b7280';

    // stats
    const statRows = el.querySelectorAll('.stat-value');
    if (statRows.length >= 3){
      statRows[0].textContent = c.avg != null ? (c.avg.toFixed(1) + ' ' + c.unit) : '‚Äî';
      statRows[1].textContent = c.min != null ? (c.min.toFixed(1) + ' ' + c.unit) : '‚Äî';
      statRows[2].textContent = c.max != null ? (c.max.toFixed(1) + ' ' + c.unit) : '‚Äî';
    }

    // üîß timestamp (ESTO FALTABA)
    const tsEl = el.querySelector('.timestamp');
    if (tsEl){
      if (c.last_at){
        // formatea local, 24h
        const d = new Date(c.last_at);
        tsEl.textContent = d.toLocaleString('es-EC', {
          year: '2-digit', month: '2-digit', day: '2-digit',
          hour: '2-digit', minute: '2-digit', hour12: false
        });
        tsEl.style.display = '';
      } else {
        tsEl.textContent = '‚Äî';
      }
    }
  }
}


  async function loadPie(params){
    const queryString = new URLSearchParams(params).toString();
    const json = await fetchJSON(`/dashboard/api/ambiente-pie/?${queryString}`);
    const ctx = document.getElementById('pie_ambiente').getContext('2d');
    const data = {
      labels: json.labels,
      datasets: [{
        data: json.data,
        backgroundColor: [
          '#10b981', '#f59e0b', '#ef4444'
        ]
      }]
    };
    const options = { 
      responsive: true, 
      maintainAspectRatio: false,
      plugins: {
        legend: {
          position: 'bottom',
          labels: {
            padding: 15,
            font: { size: 12 }
          }
        }
      }
    };
    if (pieChart) pieChart.destroy();
    pieChart = new Chart(ctx, { type: 'pie', data, options });
  }

  async function loadLines(params){
    const queryString = new URLSearchParams(params).toString();
    for(const code of metrics){
      const json = await fetchJSON(`/dashboard/api/series/${code}/?${queryString}`);
      const id = `line_${code}`;
      const ctx = document.getElementById(id).getContext('2d');
      const data = {
        labels: json.labels,
        datasets: [{
          label: `${code} (${json.unit})`,
          data: json.data,
          fill: false,
          tension: 0.3,
          borderColor: '#3b82f6',
          backgroundColor: '#3b82f6',
          borderWidth: 2,
          pointRadius: 4,
          pointHoverRadius: 7,
          pointHitRadius: 15
        }]
      };
      const options = {
        responsive: true,
        maintainAspectRatio: false,
        interaction: {
          mode: 'index',
          intersect: false
        },
        plugins: {
          legend: {
            display: false
          },
          tooltip: {
            enabled: true,
            mode: 'index',
            intersect: false,
            backgroundColor: 'rgba(0, 0, 0, 0.8)',
            padding: 12,
            cornerRadius: 6,
            titleFont: {
              size: 13,
              weight: 'bold'
            },
            bodyFont: {
              size: 13
            },
            displayColors: true,
            callbacks: {
              label: function(context) {
                let label = context.dataset.label || '';
                if (label) {
                  label += ': ';
                }
                if (context.parsed.y !== null) {
                  label += context.parsed.y.toFixed(2);
                }
                return label;
              }
            }
          }
        },
        scales: {
          y: {
            beginAtZero: false,
            grid: {
              color: '#f3f4f6'
            }
          },
          x: {
            grid: {
              display: false
            }
          }
        }
      };
      if (lineCharts[id]) lineCharts[id].destroy();
      lineCharts[id] = new Chart(ctx, { type: 'line', data, options });
    }
  }

  async function reloadAll(params){
    await Promise.all([
      loadCards(params),
      loadPie(params),
      loadLines(params)
    ]);
  }

  // Inicializar filtros
  const filterType = document.getElementById('filterType');
  const presetFilter = document.getElementById('presetFilter');
  const customFilter = document.getElementById('customFilter');
  const rangeSelect = document.getElementById('rangeSelect');
  const ambienteSelect = document.getElementById('ambienteSelect');
  const startDate = document.getElementById('startDate');
  const endDate = document.getElementById('endDate');
  const applyBtn = document.getElementById('applyCustomRange');

  // Establecer fecha m√°xima como hoy
  const today = new Date().toISOString().split('T')[0];
  endDate.value = today;
  endDate.max = today;
  
  // Establecer fecha de inicio como hace 30 d√≠as
  const thirtyDaysAgo = new Date();
  thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
  startDate.value = thirtyDaysAgo.toISOString().split('T')[0];
  startDate.max = today;

  // Cambiar tipo de filtro
  filterType.addEventListener('change', (e) => {
    currentFilterType = e.target.value;
    if (currentFilterType === 'preset') {
      presetFilter.classList.remove('hidden');
      customFilter.classList.add('hidden');
      reloadAll({ days: rangeSelect.value, ambiente: currentAmbiente });
    } else {
      presetFilter.classList.add('hidden');
      customFilter.classList.remove('hidden');
    }
  });

  // Filtro por per√≠odo predefinido
  rangeSelect.value = String(initialDays);
  rangeSelect.addEventListener('change', (e) => {
    if (currentFilterType === 'preset') {
      reloadAll({ days: e.target.value, ambiente: currentAmbiente });
    }
  });

  // Filtro por ambiente
  ambienteSelect.addEventListener('change', (e) => {
    currentAmbiente = e.target.value;
    if (currentFilterType === 'preset') {
      reloadAll({ days: rangeSelect.value, ambiente: currentAmbiente });
    } else {
      const start = startDate.value;
      const end = endDate.value;
      if (start && end) {
        reloadAll({ start_date: start, end_date: end, ambiente: currentAmbiente });
      }
    }
  });

  // Aplicar rango personalizado
  applyBtn.addEventListener('click', () => {
    const start = startDate.value;
    const end = endDate.value;
    
    if (!start || !end) {
      alert('Por favor selecciona ambas fechas');
      return;
    }
    
    if (start > end) {
      alert('La fecha de inicio debe ser anterior a la fecha final');
      return;
    }
    
    reloadAll({ start_date: start, end_date: end, ambiente: currentAmbiente });
  });

  // Validar que start_date no sea mayor que end_date
  startDate.addEventListener('change', () => {
    if (startDate.value > endDate.value) {
      endDate.value = startDate.value;
    }
  });

  endDate.addEventListener('change', () => {
    if (endDate.value < startDate.value) {
      startDate.value = endDate.value;
    }
  });

  // Carga inicial
  reloadAll({ days: initialDays, ambiente: currentAmbiente });
</script>

{% endblock %}